{% extends "layouts/base-with-nav.njk" %}

{% block title %}{{ submission.bcrCode if submission else bcr.bcrNumber }} | Register Team Internal Services{% endblock %}

{% block navigation %}
  {% include "partials/bcr-navigation.njk" %}
{% endblock %}

{% set extractedCurrentPhaseId = 1 %}
{% if submission.notes %}
  {% set notesLines = submission.notes.split('\n') %}
  {% for line in notesLines %}
    {% if line | slice(0, 14) == 'Current Phase:' %}
      {% set phaseNumber = line.replace('Current Phase:', '').trim() %}
      {% if phaseNumber | int > 0 %}
        {% set extractedCurrentPhaseId = phaseNumber | int %}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endif %}

{% block pageScripts %}
<script>
  function preSelectPhase(phaseId, phaseName, phaseStatus) {
    // Set the phase in the dropdown
    const phaseDropdown = document.getElementById('phaseId');
    if (phaseDropdown) {
      for (let i = 0; i < phaseDropdown.options.length; i++) {
        const option = phaseDropdown.options[i];
        if (option.value === phaseId) {
          phaseDropdown.selectedIndex = i;
          break;
        }
      }
    }
    
    // Find the corresponding status for this phase
    const statusDropdown = document.getElementById('status');
    if (statusDropdown && phaseStatus) {
      for (let i = 0; i < statusDropdown.options.length; i++) {
        const option = statusDropdown.options[i];
        if (option.text.includes(phaseStatus)) {
          statusDropdown.selectedIndex = i;
          break;
        }
      }
    }
    
    // Set a default comment
    const commentField = document.getElementById('comment');
    if (commentField) {
      commentField.value = `Updating Phase ${phaseId}: ${phaseName}`;
    }
    
    // Focus on the tab
    document.getElementById('tab_update-status').click();
    
    // Scroll to the form
    setTimeout(() => {
      const formElement = document.querySelector('#update-status form');
      if (formElement) {
        formElement.scrollIntoView({ behavior: 'smooth' });
      }
    }, 100);
  }
</script>
</script>
{% endblock %}

{% block head %}
  <!-- No additional styles required -->
{% endblock %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <!-- Page header with BCR ID -->
      <div class="govuk-grid-row govuk-!-margin-bottom-8">
        <div class="govuk-grid-column-two-thirds">
          <span class="govuk-caption-xl govuk-!-margin-bottom-2">Business Change Request</span>
          <h1 class="govuk-heading-xl govuk-!-margin-bottom-4">{{ submission.bcrCode if submission else bcr.bcrNumber }}</h1>
          <p class="govuk-body-l govuk-!-margin-bottom-1">Reference: <strong>{{ submission.bcrCode if submission else bcr.bcrNumber }}</strong></p>
          <p class="govuk-body-m govuk-!-margin-bottom-0">Status: 
            {% if workflow %}
              {% if workflow.status === 'new' or workflow.status === 'new_submission' %}
                <strong class="govuk-tag govuk-tag--blue">{{ workflow.status | replace('_', ' ') | title }}</strong>
              {% elif workflow.status === 'draft' %}
                <strong class="govuk-tag govuk-tag--grey">{{ workflow.status | title }}</strong>
              {% elif workflow.status === 'under_review' or workflow.status === 'being_prioritised' or workflow.status === 'under_technical_review' or workflow.status === 'in_governance_review' %}
                <strong class="govuk-tag govuk-tag--light-blue">{{ workflow.status | replace('_', ' ') | title }}</strong>
              {% elif workflow.status === 'approved' or workflow.status === 'implemented' %}
                <strong class="govuk-tag govuk-tag--green">{{ workflow.status | title }}</strong>
              {% elif workflow.status === 'rejected' %}
                <strong class="govuk-tag govuk-tag--red">{{ workflow.status | title }}</strong>
              {% else %}
                <strong class="govuk-tag">{{ workflow.status | replace('_', ' ') | title }}</strong>
              {% endif %}
            {% else %}
              <strong class="govuk-tag govuk-tag--grey">Unknown</strong>
            {% endif %}
          </p>
        </div>
        <div class="govuk-grid-column-one-third">
          <div class="app-card app-card--highlight govuk-!-margin-top-2">
            <p class="govuk-body-s govuk-!-margin-bottom-1">Submitted on</p>
            {% if submissionDates and submissionDates.length > 1 %}
              <ul class="govuk-list govuk-list--bullet govuk-!-margin-bottom-4">
                {% for date in submissionDates %}
                  <li><strong>{{ date | ukDate }}</strong></li>
                {% endfor %}
              </ul>
            {% elif submissionDates and submissionDates.length == 1 %}
              <p class="govuk-body-l govuk-!-margin-bottom-4"><strong>{{ submissionDates[0] | ukDate }}</strong></p>
            {% else %}
              <p class="govuk-body-l govuk-!-margin-bottom-4"><strong>Unknown</strong></p>
            {% endif %}
            <p class="govuk-body-s govuk-!-margin-bottom-1">Last Updated</p>
            <p class="govuk-body-l govuk-!-margin-bottom-4"><strong>{% if submission and submission.updatedAt %}{{ submission.updatedAt | date('DD MMM YYYY') }}{% elif bcr and bcr.updatedAt %}{{ bcr.updatedAt | date('DD MMM YYYY') }}{% else %}Unknown{% endif %}</strong></p>
            <p class="govuk-body-s govuk-!-margin-bottom-1">Priority</p>
            <p class="govuk-body-l govuk-!-margin-bottom-0">
              {% if submission and submission.priority %}
                {% if submission.priority === 'critical' %}
                  <strong class="govuk-tag govuk-tag--red">{{ submission.priority | title }}</strong>
                {% elif submission.priority === 'high' %}
                  <strong class="govuk-tag govuk-tag--orange">{{ submission.priority | title }}</strong>
                {% elif submission.priority === 'medium' %}
                  <strong class="govuk-tag govuk-tag--yellow">{{ submission.priority | title }}</strong>
                {% elif submission.priority === 'low' %}
                  <strong class="govuk-tag govuk-tag--green">{{ submission.priority | title }}</strong>
                {% else %}
                  <strong class="govuk-tag govuk-tag--grey">{{ submission.priority | title }}</strong>
                {% endif %}
              {% elif bcr and bcr.priority %}
                {% if bcr.priority === 'critical' %}
                  <strong class="govuk-tag govuk-tag--red">{{ bcr.priority | title }}</strong>
                {% elif bcr.priority === 'high' %}
                  <strong class="govuk-tag govuk-tag--orange">{{ bcr.priority | title }}</strong>
                {% elif bcr.priority === 'medium' %}
                  <strong class="govuk-tag govuk-tag--yellow">{{ bcr.priority | title }}</strong>
                {% elif bcr.priority === 'low' %}
                  <strong class="govuk-tag govuk-tag--green">{{ bcr.priority | title }}</strong>
                {% else %}
                  <strong class="govuk-tag govuk-tag--grey">{{ bcr.priority | title }}</strong>
                {% endif %}
              {% else %}
                <strong class="govuk-tag govuk-tag--grey">Not Set</strong>
              {% endif %}
            </p>
          </div>
        </div>
      </div>
      


      <!-- Status and Actions Grid -->
      <div class="govuk-grid-row govuk-!-margin-bottom-8">
        <!-- Current Phase Card (Moved to first position) -->
        <div class="govuk-grid-column-one-third">
          <div class="app-card app-card--highlight">
            <h3 class="govuk-heading-m govuk-!-margin-bottom-2">Current Phase</h3>
            <p class="govuk-body-l govuk-!-margin-bottom-0">
              {% set lastCompletedPhase = null %}
              {% set lastCompletedPhaseStatus = null %}
              
              {% if submission and submission.currentPhaseName %}
                <strong>{{ submission.currentPhaseName }}</strong><br>
              {% else %}
                {% set found = false %}
                {% if phases and submission and submission.currentPhaseId %}
                  {% for phase in phases %}
                    {% if not found and phase.value and submission.currentPhaseId and phase.value|string == submission.currentPhaseId|string %}
                      {% set found = true %}
                      <strong>{{ phase.name }}</strong><br>
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {% if not found %}
                  <strong>Unknown Phase</strong><br>
                {% endif %}
              {% endif %}
              
              {% if lastCompletedPhaseStatus %}
                <strong class="govuk-tag govuk-tag--green">{{ lastCompletedPhaseStatus }}</strong>
              {% elif submission.status === 'new_submission' or submission.status === 'submitted' %}
                <strong class="govuk-tag govuk-tag--purple">Submission Received</strong>
              {% elif submission.status === 'under_review' %}
                <strong class="govuk-tag govuk-tag--blue">Under Review</strong>
              {% elif submission.status === 'approved' %}
                <strong class="govuk-tag govuk-tag--green">Approved</strong>
              {% elif submission.status === 'being_prioritised' %}
                <strong class="govuk-tag govuk-tag--yellow">Being Prioritised</strong>
              {% elif submission.status === 'under_technical_review' or submission.status === 'in_governance_review' %}
                <strong class="govuk-tag govuk-tag--light-blue">In Review</strong>
              {% elif submission.status === 'consulting_stakeholders' %}
                <strong class="govuk-tag govuk-tag--light-blue">Consulting Stakeholders</strong>
              {% elif submission.status === 'drafting_in_progress' %}
                <strong class="govuk-tag govuk-tag--light-blue">Drafting In Progress</strong>
              {% elif submission.status === 'awaiting_final_approval' %}
                <strong class="govuk-tag govuk-tag--yellow">Awaiting Approval</strong>
              {% elif submission.status === 'being_implemented' %}
                <strong class="govuk-tag govuk-tag--light-blue">Being Implemented</strong>
              {% elif submission.status === 'testing_in_progress' %}
                <strong class="govuk-tag govuk-tag--light-blue">Testing In Progress</strong>
              {% elif submission.status === 'preparing_for_go_live' %}
                <strong class="govuk-tag govuk-tag--turquoise">Preparing For Go Live</strong>
              {% elif submission.status === 'implemented' %}
                <strong class="govuk-tag govuk-tag--green">Implemented</strong>
              {% elif submission.status === 'rejected' %}
                <strong class="govuk-tag govuk-tag--red">Rejected</strong>
              {% elif submission.status === 'under_post_implementation_review' %}
                <strong class="govuk-tag govuk-tag--light-blue">Post Implementation Review</strong>
              {% elif submission.status === 'closing' %}
                <strong class="govuk-tag govuk-tag--green">Closing</strong>
              {% else %}
                <strong class="govuk-tag govuk-tag--grey">{{ submission.status }}</strong>
              {% endif %}
            </p>
          </div>
        </div>
        
        <!-- Current Status Card (Moved to second position) -->
        <div class="govuk-grid-column-one-third">
          <div class="app-card app-card--highlight">
            <h3 class="govuk-heading-m govuk-!-margin-bottom-2">Current Status</h3>
            <p class="govuk-body-l govuk-!-margin-bottom-0">
              <strong>{{ submission.statusDisplay }}</strong><br>
              
              {% if submission.status === 'new_submission' or submission.status === 'submitted' %}
                <strong class="govuk-tag govuk-tag--purple">Submission Received</strong>
              {% elif submission.status === 'under_review' %}
                <strong class="govuk-tag govuk-tag--blue">Under Review</strong>
              {% elif submission.status === 'approved' %}
                <strong class="govuk-tag govuk-tag--green">Approved</strong>
              {% elif submission.status === 'being_prioritised' %}
                <strong class="govuk-tag govuk-tag--yellow">Being Prioritised</strong>
              {% elif submission.status === 'under_technical_review' %}
                <strong class="govuk-tag govuk-tag--light-blue">Technical Review</strong>
              {% elif submission.status === 'in_governance_review' %}
                <strong class="govuk-tag govuk-tag--light-blue">Governance Review</strong>
              {% elif submission.status === 'consulting_stakeholders' %}
                <strong class="govuk-tag govuk-tag--light-blue">Consulting Stakeholders</strong>
              {% elif submission.status === 'drafting_in_progress' %}
                <strong class="govuk-tag govuk-tag--light-blue">Drafting In Progress</strong>
              {% elif submission.status === 'awaiting_final_approval' %}
                <strong class="govuk-tag govuk-tag--yellow">Awaiting Approval</strong>
              {% elif submission.status === 'being_implemented' %}
                <strong class="govuk-tag govuk-tag--light-blue">Being Implemented</strong>
              {% elif submission.status === 'testing_in_progress' %}
                <strong class="govuk-tag govuk-tag--light-blue">Testing In Progress</strong>
              {% elif submission.status === 'preparing_for_go_live' %}
                <strong class="govuk-tag govuk-tag--turquoise">Preparing For Go Live</strong>
              {% elif submission.status === 'implemented' %}
                <strong class="govuk-tag govuk-tag--green">Implemented</strong>
              {% elif submission.status === 'rejected' %}
                <strong class="govuk-tag govuk-tag--red">Rejected</strong>
              {% elif submission.status === 'under_post_implementation_review' %}
                <strong class="govuk-tag govuk-tag--light-blue">Post Implementation Review</strong>
              {% elif submission.status === 'closing' %}
                <strong class="govuk-tag govuk-tag--green">Closing</strong>
              {% elif submission.status === 'draft' %}
                <strong class="govuk-tag govuk-tag--grey">Draft</strong>
              {% else %}
                <strong class="govuk-tag govuk-tag--grey">{{ submission.status }}</strong>
              {% endif %}
            </p>
          </div>
        </div>
        
        <!-- Available Actions Card -->
        <div class="govuk-grid-column-one-third">
          <div class="app-card app-card--highlight">
            <h3 class="govuk-heading-m govuk-!-margin-bottom-2">Available Actions</h3>
            <div class="govuk-button-group">
              <a href="#" class="govuk-button govuk-button--warning govuk-!-margin-bottom-0">Reject</a>
            </div>
          </div>
        </div>
      </div>

      <!-- BCR Details Tabs -->
      <div class="govuk-tabs" data-module="govuk-tabs">
        <h2 class="govuk-tabs__title">BCR Information</h2>
        <ul class="govuk-tabs__list" role="tablist">
          <li class="govuk-tabs__list-item govuk-tabs__list-item--selected" role="presentation">
            <a class="govuk-tabs__tab" href="#details" id="tab_details" role="tab" aria-controls="details" aria-selected="true" tabindex="0">
              Details
            </a>
          </li>

          <li class="govuk-tabs__list-item" role="presentation">
            <a class="govuk-tabs__tab" href="#workflow-actions" id="tab_workflow-actions" role="tab" aria-controls="workflow-actions" tabindex="-1">
              Workflow Actions
            </a>
          </li>
          <li class="govuk-tabs__list-item" role="presentation">
            <a class="govuk-tabs__tab" href="#prioritisation" id="tab_prioritisation" role="tab" aria-controls="prioritisation" tabindex="-1">
              Prioritisation
            </a>
          </li>
          <li class="govuk-tabs__list-item" role="presentation">
            <a class="govuk-tabs__tab" href="#impact-areas" id="tab_impact-areas" role="tab" aria-controls="impact-areas" tabindex="-1">
              Impact Areas
            </a>
          </li>
          <li class="govuk-tabs__list-item" role="presentation">
            <a class="govuk-tabs__tab" href="#update-status" id="tab_update-status" role="tab" aria-controls="update-status" tabindex="-1">
              Update Status
            </a>
          </li>
          <li class="govuk-tabs__list-item" role="presentation">
            <a class="govuk-tabs__tab" href="#reset-workflow" id="tab_reset-workflow" role="tab" aria-controls="reset-workflow" tabindex="-1">
              Reset Workflow
            </a>
          </li>
          <li class="govuk-tabs__list-item" role="presentation">
            <a class="govuk-tabs__tab" href="#history" id="tab_history" role="tab" aria-controls="history" tabindex="-1">
              Change History
            </a>
          </li>
        </ul>
        
        <!-- Details Tab -->
        <div class="govuk-tabs__panel" id="details" role="tabpanel" aria-labelledby="tab_details" tabindex="0">
          <h2 class="govuk-heading-l govuk-!-margin-bottom-6">BCR Submission Details</h2>
          
          <!-- Summary Card -->
          <div class="govuk-grid-row govuk-!-margin-bottom-8">
            <div class="govuk-grid-column-full">
              <div class="app-card app-card--highlight">
                <div class="govuk-grid-row">
                  <div class="govuk-grid-column-one-half">
                    <h3 class="govuk-heading-s govuk-!-margin-bottom-2">Submission Information</h3>
                    <ul class="govuk-list">
                      <li><strong>Reference:</strong> {{ submission.id }}</li>
                      <li><strong>Submitted:</strong> {{ submission.dateSubmitted | ukDate }}</li>
                      <li><strong>Last Updated:</strong> {{ submission.lastUpdated | ukDate }}</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Section 1: Submitter Information -->
          <div class="govuk-grid-row govuk-!-margin-bottom-8">
            <div class="govuk-grid-column-full">
              <div class="app-card">
                <h3 class="govuk-heading-m govuk-!-margin-bottom-4">1. Submitter Information</h3>
                <dl class="govuk-summary-list">
                  <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" style="width: auto; max-width: none;">Full Name</dt>
                    <dd class="govuk-summary-list__value">
                      {% if submission.submitter and submission.submitter.name %}
                        {{ submission.submitter.name }}
                      {% else %}
                        {{ submission.submitterName }}
                      {% endif %}
                    </dd>
                  </div>
                  <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" style="width: auto; max-width: none;">Email Address</dt>
                    <dd class="govuk-summary-list__value">
                      {% if submission.submitter and submission.submitter.email %}
                        {{ submission.submitter.email }}
                      {% else %}
                        {{ submission.submitterEmail }}
                      {% endif %}
                    </dd>
                  </div>
                  <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" style="width: auto; max-width: none;">DfE Affiliation</dt>
                    <dd class="govuk-summary-list__value">
                      {% if submission.employmentType === 'yes' %}
                        <strong class="govuk-tag govuk-tag--blue">Internal DfE</strong>
                      {% elif submission.employmentType === 'no' %}
                        <strong class="govuk-tag govuk-tag--purple">External</strong>
                      {% else %}
                        <strong class="govuk-tag govuk-tag--grey">Other</strong>
                      {% endif %}
                    </dd>
                  </div>
                  <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" style="width: auto; max-width: none;">Organisation / Department</dt>
                    <dd class="govuk-summary-list__value">
                      {% if submission.submitter and submission.submitter.organisation %}
                        {{ submission.submitter.organisation }}
                      {% else %}
                        {{ submission.submitterOrganisation }}
                      {% endif %}
                    </dd>
                  </div>
                </dl>
              </div>
            </div>
          </div>
          
          <!-- Section 2: Change Request Details -->
          <div class="govuk-grid-row govuk-!-margin-bottom-8">
            <div class="govuk-grid-column-full">
              <div class="app-card">
                <h3 class="govuk-heading-m govuk-!-margin-bottom-4">2. Change Request Details</h3>
                <dl class="govuk-summary-list">
                  <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" style="width: auto; max-width: none;">Description</dt>
                    <dd class="govuk-summary-list__value">{{ submission.description }}</dd>
                  </div>
                  <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" style="width: auto; max-width: none;">Reason for Change / Justification</dt>
                    <dd class="govuk-summary-list__value">{{ submission.justification }}</dd>
                  </div>
                  <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" style="width: auto; max-width: none;">Change Request Relates To</dt>
                    <dd class="govuk-summary-list__value">
                      {% if submission.changeType and submission.changeType.length > 0 %}
                        <div class="govuk-!-margin-bottom-2">
                          {% for type in submission.changeType %}
                            {% if type === 'API' %}
                              <span class="govuk-tag govuk-tag--purple govuk-!-margin-right-1 govuk-!-margin-bottom-1">API</span>
                            {% elif type === 'CSV' %}
                              <span class="govuk-tag govuk-tag--turquoise govuk-!-margin-right-1 govuk-!-margin-bottom-1">CSV</span>
                            {% elif type === 'Frontend UI' %}
                              <span class="govuk-tag govuk-tag--pink govuk-!-margin-right-1 govuk-!-margin-bottom-1">Frontend UI</span>
                            {% elif type === 'Validation' %}
                              <span class="govuk-tag govuk-tag--orange govuk-!-margin-right-1 govuk-!-margin-bottom-1">Validation</span>
                            {% elif type === 'Reference Data' %}
                              <span class="govuk-tag govuk-tag--green govuk-!-margin-right-1 govuk-!-margin-bottom-1">Reference Data</span>
                            {% elif type === 'Content and Guidance' %}
                              <span class="govuk-tag govuk-tag--light-blue govuk-!-margin-right-1 govuk-!-margin-bottom-1">Content and Guidance</span>
                            {% else %}
                              <span class="govuk-tag govuk-!-margin-right-1 govuk-!-margin-bottom-1">{{ type }}</span>
                            {% endif %}
                          {% endfor %}
                        </div>
                      {% else %}
                        <span class="govuk-hint">None specified</span>
                      {% endif %}
                    </dd>
                  </div>
                  <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" style="width: auto; max-width: none;">Urgency of Change</dt>
                    <dd class="govuk-summary-list__value">
                      {% if submission.urgency == 'Critical' %}
                        <strong class="govuk-tag govuk-tag--red">{{ submission.urgency }}</strong>
                      {% elif submission.urgency == 'High' %}
                        <strong class="govuk-tag govuk-tag--orange">{{ submission.urgency }}</strong>
                      {% elif submission.urgency == 'Medium' %}
                        <strong class="govuk-tag govuk-tag--yellow">{{ submission.urgency }}</strong>
                      {% elif submission.urgency == 'Low' %}
                        <strong class="govuk-tag govuk-tag--green">{{ submission.urgency }}</strong>
                      {% elif submission.urgency == 'Unknown' %}
                        <strong class="govuk-tag govuk-tag--grey">{{ submission.urgency }}</strong>
                      {% else %}
                        <strong class="govuk-tag">{{ submission.urgency }}</strong>
                      {% endif %}
                    </dd>
                  </div>
                </dl>
              </div>
            </div>
          </div>
          
          <!-- Section 3: Technical Details -->
          <div class="govuk-grid-row govuk-!-margin-bottom-8">
            <div class="govuk-grid-column-full">
              <div class="app-card">
                <h3 class="govuk-heading-m govuk-!-margin-bottom-4">3. Technical Details</h3>
                <dl class="govuk-summary-list">
                  <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" style="width: auto; max-width: none;">Affected Reference Data Area</dt>
                    <dd class="govuk-summary-list__value">
                      {% if submission.affectedRefDataArea %}
                        {{ submission.affectedRefDataArea }}
                      {% else %}
                        <span class="govuk-hint">None specified</span>
                      {% endif %}
                    </dd>
                  </div>
                  <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" style="width: auto; max-width: none;">Technical Dependencies</dt>
                    <dd class="govuk-summary-list__value">
                      {% if submission.technicalDependencies %}
                        {{ submission.technicalDependencies }}
                      {% else %}
                        <span class="govuk-hint">None specified</span>
                      {% endif %}
                    </dd>
                  </div>
                </dl>
              </div>
            </div>
          </div>
          
          <!-- Section 4: Supporting Information -->
          <div class="govuk-grid-row govuk-!-margin-bottom-8">
            <div class="govuk-grid-column-full">
              <div class="app-card">
                <h3 class="govuk-heading-m govuk-!-margin-bottom-4">4. Supporting Information</h3>
                <dl class="govuk-summary-list">
                  <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" style="width: auto; max-width: none;">Related Documents</dt>
                    <dd class="govuk-summary-list__value">
                      {% if submission.relatedDocuments and submission.relatedDocuments.length > 0 %}
                        <ul class="govuk-list govuk-list--bullet">
                          {% for doc in submission.relatedDocuments %}
                            <li>
                              {% if doc and (doc.startsWith('http://') or doc.startsWith('https://')) %}
                                <a href="{{ doc }}" class="govuk-link" target="_blank" rel="noopener noreferrer">{{ doc }}</a>
                              {% else %}
                                {{ doc }}
                              {% endif %}
                            </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <span class="govuk-hint">None specified</span>
                      {% endif %}
                    </dd>
                  </div>
                  <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" style="width: auto; max-width: none;">Has Attachments</dt>
                    <dd class="govuk-summary-list__value">
                      {% if submission.hasAttachments %}
                        <strong class="govuk-tag govuk-tag--blue">Yes</strong>
                      {% else %}
                        <strong class="govuk-tag govuk-tag--grey">No</strong>
                      {% endif %}
                    </dd>
                  </div>
                  <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" style="width: auto; max-width: none;">Additional Comments</dt>
                    <dd class="govuk-summary-list__value">
                      {% if submission.additionalComments %}
                        {{ submission.additionalComments }}
                      {% else %}
                        <span class="govuk-hint">None provided</span>
                      {% endif %}
                    </dd>
                  </div>
                </dl>
              </div>
            </div>
          </div>
        </div>
        

        
        <!-- Workflow Actions Tab -->
        <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="workflow-actions" role="tabpanel" aria-labelledby="tab_workflow-actions" tabindex="0">
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
              <h2 class="govuk-heading-l">Workflow Management</h2>
              
              <!-- Workflow Actions Summary -->
              <div class="govuk-grid-row">
                <div class="govuk-grid-column-full">
                  <div class="govuk-inset-text govuk-!-margin-bottom-6">
                    <h3 class="govuk-heading-m govuk-!-margin-bottom-2">Available Actions</h3>
                    <p class="govuk-body">Select an action below to progress this BCR through the workflow:</p>
                    <div class="govuk-button-group govuk-!-margin-top-4">
                      <a href="#update-status" class="govuk-button" data-module="govuk-button" onclick="document.getElementById('tab_update-status').click()">
                        Update Status
                      </a>
                      <a href="/direct/bcr-submissions/{{ submission.id }}/edit" class="govuk-button govuk-button--secondary" data-module="govuk-button">
                        Edit BCR
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Workflow Progress -->
              <div class="govuk-grid-row">
                <div class="govuk-grid-column-full">
                  <div class="app-card govuk-!-margin-bottom-6">
                    <h2 class="govuk-heading-l" id="workflow">Workflow Progress for {{ submission.bcrNumber }}</h2>
                    
                    <!-- Current Phase and Status Summary Box -->
                    <div class="govuk-inset-text govuk-!-margin-bottom-6">
                      {% set currentPhase = phases | selectattr('id', 'equalto', submission.currentPhaseId) | first if submission.currentPhaseId else phases | first %}
                      {% set phaseNameParts = currentPhase.name.split(' - ') if currentPhase else ['Unknown', ''] %}
                      {% set currentPhaseMainName = phaseNameParts[0] %}
                      {% set currentPhaseStatus = phaseNameParts[1] if phaseNameParts.length > 1 else '' %}
                      
                      <h3 class="govuk-heading-m govuk-!-margin-bottom-2">Current Phase and Status</h3>
                      <div class="govuk-summary-list">
                        <div class="govuk-summary-list__row">
                          <dt class="govuk-summary-list__key">Current Phase</dt>
                          <dd class="govuk-summary-list__value">
                            <strong class="govuk-tag govuk-tag--turquoise">{{ currentPhaseMainName }}</strong>
                          </dd>
                        </div>
                        <div class="govuk-summary-list__row">
                          <dt class="govuk-summary-list__key">Current Status</dt>
                          <dd class="govuk-summary-list__value">
                            {% if submission.status === 'Submission Received' %}
                              <strong class="govuk-tag govuk-tag--purple">{{ submission.status }}</strong>
                            {% elif submission.status === 'Under Review' %}
                              <strong class="govuk-tag govuk-tag--blue">{{ submission.status }}</strong>
                            {% elif submission.status === 'Approved' %}
                              <strong class="govuk-tag govuk-tag--green">{{ submission.status }}</strong>
                            {% elif submission.status === 'In Progress' %}
                              <strong class="govuk-tag govuk-tag--light-blue">{{ submission.status }}</strong>
                            {% elif submission.status === 'Implemented' %}
                              <strong class="govuk-tag govuk-tag--pink">{{ submission.status }}</strong>
                            {% elif submission.status === 'Go Live' %}
                              <strong class="govuk-tag govuk-tag--turquoise">{{ submission.status }}</strong>
                            {% elif submission.status === 'Completed' %}
                              <strong class="govuk-tag govuk-tag--green">{{ submission.status }}</strong>
                            {% elif submission.status === 'Rejected' %}
                              <strong class="govuk-tag govuk-tag--red">{{ submission.status }}</strong>
                            {% else %}
                              <strong class="govuk-tag govuk-tag--grey">{{ submission.status }}</strong>
                            {% endif %}
                          </dd>
                        </div>
                        <div class="govuk-summary-list__row">
                          <dt class="govuk-summary-list__key">Last Updated</dt>
                          <dd class="govuk-summary-list__value">
                            {{ submission.lastUpdated | ukDateWithDay if submission.lastUpdated else "Not available" }}
                          </dd>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Workflow Phases Timeline Section -->
                    <div class="govuk-!-margin-top-6">
                      <h3 class="govuk-heading-m govuk-!-margin-bottom-4">Workflow Phases</h3>
                      
                      <!-- Group phases by functional area based on BCR workflow page -->
                      {% set phaseGroups = {
                        "Submission & Initial Review": phases | selectattr("id", "ge", 1) | selectattr("id", "le", 3),
                        "Review & Approval": phases | selectattr("id", "ge", 4) | selectattr("id", "le", 6),
                        "Requirements Documentation": phases | selectattr("id", "ge", 7) | selectattr("id", "le", 9),
                        "Implementation & Release": phases | selectattr("id", "ge", 10) | selectattr("id", "le", 11),
                        "Release Management": phases | selectattr("id", "ge", 12)
                      } %}
                      
                      {% for groupName, groupPhases in phaseGroups %}
                        {% if groupPhases.length > 0 %}
                          <h4 class="govuk-heading-s govuk-!-margin-bottom-2">{{ groupName }}</h4>
                          <div class="govuk-inset-text govuk-!-margin-bottom-6">
                            <dl class="govuk-summary-list">
                              {% for phase in groupPhases %}
                                {# Extract current phase from notes if available #}
                                {% set extractedCurrentPhaseId = 1 %}
                                {% if submission.notes %}
                                  {% set notesLines = submission.notes.split('\n') %}
                                  {% for line in notesLines %}
                                    {% if line.startsWith('Current Phase:') %}
                                      {% set phaseNumber = line.replace('Current Phase:', '').trim() %}
                                      {% if phaseNumber | int > 0 %}
                                        {% set extractedCurrentPhaseId = phaseNumber | int %}
                                      {% endif %}
                                    {% endif %}
                                  {% endfor %}
                                {% endif %}
                                {% set isCurrentPhase = phase.value | int === extractedCurrentPhaseId %}
                                {% set isCompletedPhase = phase.value | int < extractedCurrentPhaseId %}
                                {% set isFuturePhase = phase.value | int > extractedCurrentPhaseId %}
                                
                                {% set phaseNameParts = phase.name.split(' - ') %}
                                {% set phaseMainName = phaseNameParts[0] %}
                                {% set phaseStatus = phaseNameParts[1] if phaseNameParts.length > 1 else '' %}
                                
                                {% set phaseCompletionDate = null %}
                                {% if submission.notes and isCompletedPhase %}
                                  {% set notesLines = submission.notes.split('\n') %}
                                  {% for line in notesLines %}
                                    {% if ('Phase ' + phase.value + ' completed') in line and 'on ' in line %}
                                      {% set dateParts = line.split('on ') %}
                                      {% if dateParts.length > 1 %}
                                        {% set dateString = dateParts[1].split(' ')[0] %}
                                        {% set phaseCompletionDate = dateString %}
                                      {% endif %}
                                    {% endif %}
                                  {% endfor %}
                                {% endif %}
                                
                                <!-- Set phase tag color based on group -->
                                {% set phaseTagClass = "govuk-tag--blue" %}
                                {% if phase.id >= 1 and phase.id <= 3 %}
                                  {% set phaseTagClass = "govuk-tag--blue" %}
                                {% elif phase.id >= 4 and phase.id <= 6 %}
                                  {% set phaseTagClass = "govuk-tag--purple" %}
                                {% elif phase.id >= 7 and phase.id <= 9 %}
                                  {% set phaseTagClass = "govuk-tag--orange" %}
                                {% elif phase.id >= 10 %}
                                  {% set phaseTagClass = "govuk-tag--red" %}
                                {% endif %}
                                
                                <!-- Phase row -->
                                <div class="govuk-summary-list__row">
                                  <dt class="govuk-summary-list__key" style="width: 15%;">
                                    <strong class="govuk-tag {{ phaseTagClass }}">Phase {{ phase.id }}</strong>
                                  </dt>
                                  <dd class="govuk-summary-list__value">
                                    <h4 class="govuk-heading-s govuk-!-margin-bottom-2">{{ phaseMainName }}</h4>
                                    
                                    {% if isCurrentPhase %}
                                      {% set statusObj = statuses | selectattr('phase', 'equalto', phase.id) | first %}
                                      {% if statusObj %}
                                        <p class="govuk-body-s govuk-!-margin-bottom-1 govuk-!-margin-top-3">Status:</p>
                                        <strong class="govuk-tag govuk-tag--light-blue">{{ statusObj.name }}</strong>
                                      {% elif phaseStatus %}
                                        <p class="govuk-body-s govuk-!-margin-bottom-1 govuk-!-margin-top-3">Status:</p>
                                        <strong class="govuk-tag govuk-tag--light-blue">{{ phaseStatus }}</strong>
                                      {% endif %}
                                    {% elif isCompletedPhase %}
                                      <p class="govuk-body-s govuk-!-margin-bottom-1 govuk-!-margin-top-3">Status:</p>
                                      <strong class="govuk-tag govuk-tag--green">Completed</strong>
                                      {% if phaseCompletionDate %}
                                        <p class="govuk-body-s govuk-!-margin-top-2">Completed on: {{ phaseCompletionDate | ukDate }}</p>
                                      {% endif %}
                                    {% elif isFuturePhase %}
                                      <p class="govuk-body-s govuk-!-margin-bottom-1 govuk-!-margin-top-3">Status:</p>
                                      <strong class="govuk-tag govuk-tag--grey">Pending</strong>
                                    {% endif %}
                                  </dd>
                                  <dd class="govuk-summary-list__actions">
                                    {% if isCurrentPhase %}
                                      <a href="#update-status" class="govuk-link" onclick="preSelectPhase('{{ phase.id }}', '{{ phaseMainName }}', '{{ phaseStatus }}')">
                                        Update<span class="govuk-visually-hidden"> status for {{ phaseMainName }}</span>
                                      </a>
                                    {% endif %}
                                  </dd>
                                </div>
                                

                              {% endfor %}
                            </dl>
                          </div>
                        {% endif %}
                      {% endfor %}
                      
                      <!-- Special Status Items -->
                      {% if submission.status === 'Rejected' %}
                        <h4 class="govuk-heading-s govuk-!-margin-bottom-2">Rejection Details</h4>
                        <div class="govuk-inset-text govuk-!-margin-bottom-6" style="border-left: 5px solid #942514;">
                          <dl class="govuk-summary-list">
                            <div class="govuk-summary-list__row">
                              <dt class="govuk-summary-list__key" style="width: 15%;">
                                <strong class="govuk-tag govuk-tag--red">Rejected</strong>
                              </dt>
                              <dd class="govuk-summary-list__value">
                                <h4 class="govuk-heading-s govuk-!-margin-bottom-2">BCR Rejected</h4>
                                <p class="govuk-body-s">This BCR has been rejected by {{ submission.reviewer if submission.reviewer else 'System' }} and will not proceed further.</p>
                                <p class="govuk-body-s govuk-!-margin-top-2">Rejected on: {{ submission.lastUpdated | ukDate if submission.lastUpdated else "Unknown date" }}</p>
                              </dd>
                              <dd class="govuk-summary-list__actions"></dd>
                            </div>
                          </dl>
                        </div>
                      {% endif %}
                      
                      {% if submission.status === 'Completed' %}
                        <h4 class="govuk-heading-s govuk-!-margin-bottom-2">Completion Details</h4>
                        <div class="govuk-inset-text govuk-!-margin-bottom-6" style="border-left: 5px solid #005a30;">
                          <dl class="govuk-summary-list">
                            <div class="govuk-summary-list__row">
                              <dt class="govuk-summary-list__key" style="width: 15%;">
                                <strong class="govuk-tag govuk-tag--green">Completed</strong>
                              </dt>
                              <dd class="govuk-summary-list__value">
                                <h4 class="govuk-heading-s govuk-!-margin-bottom-2">BCR Completed</h4>
                                <p class="govuk-body-s">This BCR has been successfully completed by {{ submission.reviewer if submission.reviewer else 'System' }}.</p>
                                <p class="govuk-body-s govuk-!-margin-top-2">Completed on: {{ submission.completedDate | ukDate if submission.completedDate else submission.lastUpdated | ukDate }}</p>
                              </dd>
                              <dd class="govuk-summary-list__actions"></dd>
                            </div>
                          </dl>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              

              
              <!-- Workflow History -->
              <div class="app-card">
                <h3 class="govuk-heading-m">Workflow History</h3>
                <table class="govuk-table">
                  <thead class="govuk-table__head">
                    <tr class="govuk-table__row">
                      <th scope="col" class="govuk-table__header">Action</th>
                      <th scope="col" class="govuk-table__header">Date</th>
                      <th scope="col" class="govuk-table__header">User</th>
                    </tr>
                  </thead>
                  <tbody class="govuk-table__body">
                    <tr class="govuk-table__row">
                      <td class="govuk-table__cell">Submission Received</td>
                      <td class="govuk-table__cell">{{ submission.dateSubmitted | ukDate }}</td>
                      <td class="govuk-table__cell">{{ submission.submitter.name }}</td>
                    </tr>
                    {% if submission.notes %}
                      {# Display workflow history entries directly from the notes #}
                      {% set notesLines = submission.notes.split('\n') %}
                      {% set inHistoryEntry = false %}
                      {% set currentAction = '' %}
                      {% set currentDate = '' %}
                      {% set currentUser = '' %}
                      
                      {% for line in notesLines %}
                        {% if '--- WORKFLOW HISTORY ENTRY ---' in line %}
                          {% set inHistoryEntry = true %}
                        {% elif inHistoryEntry and line | slice(0, 7) == 'Action:' %}
                          {% set currentAction = line.replace('Action:', '').trim() %}
                        {% elif inHistoryEntry and line | slice(0, 5) == 'Date:' %}
                          {% set currentDate = line.replace('Date:', '').trim() %}
                        {% elif inHistoryEntry and line | slice(0, 5) == 'User:' %}
                          {% set currentUser = line.replace('User:', '').trim() %}
                        {% elif inHistoryEntry and line | slice(0, 10) == 'Completed:' %}
                          {# End of entry, display it #}
                          <tr class="govuk-table__row">
                            <td class="govuk-table__cell">{{ currentAction }}</td>
                            <td class="govuk-table__cell">{{ currentDate | ukDate }}</td>
                            <td class="govuk-table__cell">{{ currentUser }}</td>
                          </tr>
                          {% set inHistoryEntry = false %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Prioritisation Tab -->
        <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="prioritisation" role="tabpanel" aria-labelledby="tab_prioritisation" tabindex="0">
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
              <h2 class="govuk-heading-l">Prioritise BCR</h2>
              
              <div class="govuk-grid-row">
                <div class="govuk-grid-column-two-thirds">
                  <form action="/bcr/prioritisation/save" method="post">
                    <div class="govuk-form-group">
                      <fieldset class="govuk-fieldset">
                        <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
                          <h3 class="govuk-fieldset__heading">Prioritisation Details</h3>
                        </legend>
                        
                        <div class="govuk-inset-text">
                          <p class="govuk-body">You are prioritising BCR: <strong>{{ submission.id }}</strong> - {{ submission.title }}</p>
                        </div>
                        
                        <!-- Hidden BCR ID field -->
                        <input type="hidden" name="bcrId" value="{{ submission.id }}">
                        
                        <div class="govuk-form-group">
                          <label class="govuk-label" for="trelloTicketId">
                            Trello Ticket ID <span class="govuk-required">*</span>
                          </label>
                          <input class="govuk-input" id="trelloTicketId" name="trelloTicketId" type="text" value="{{ submission.trelloId }}" required>
                        </div>
                        
                        <div class="govuk-form-group">
                          <label class="govuk-label" for="description">
                            Description <span class="govuk-required">*</span>
                          </label>
                          <input class="govuk-input" id="description" name="description" type="text" value="{{ submission.title }}" required>
                        </div>
                        
                        <div class="govuk-form-group">
                          <label class="govuk-label" for="prioritisationFlag">
                            Prioritisation Flag <span class="govuk-required">*</span>
                          </label>
                          <select class="govuk-select" id="prioritisationFlag" name="prioritisationFlag" required>
                            <option value="">Select a prioritisation flag</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                            <option value="Urgent">Urgent</option>
                            <option value="On Hold">On Hold</option>
                          </select>
                        </div>
                        
                        <div class="govuk-form-group">
                          <label class="govuk-label" for="prioritisationNarrative">
                            Prioritisation Narrative <span class="govuk-required">*</span>
                          </label>
                          <textarea class="govuk-textarea" id="prioritisationNarrative" name="prioritisationNarrative" rows="5" required></textarea>
                        </div>
                        
                        <div class="govuk-form-group">
                          <label class="govuk-label" for="currentStatus">
                            Current Status <span class="govuk-required">*</span>
                          </label>
                          <input class="govuk-input" id="currentStatus" name="currentStatus" type="text" value="{{ submission.status }}" required>
                        </div>
                      </fieldset>
                    </div>
                    
                    <div class="govuk-button-group">
                      <button class="govuk-button" data-module="govuk-button">
                        Save Prioritisation
                      </button>
                      <a href="#details" class="govuk-button govuk-button--secondary">
                        Cancel
                      </a>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Update Status Tab -->
        <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="update-status" role="tabpanel" aria-labelledby="tab_update-status" tabindex="0">
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
              <h2 class="govuk-heading-l">Update BCR Status</h2>
              
              <form action="/direct/bcr-submissions/{{ submission.id }}/update" method="post" class="govuk-!-margin-bottom-6">
                <div class="govuk-form-group">
                  <fieldset class="govuk-fieldset">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
                      <h3 class="govuk-fieldset__heading">Update Status</h3>
                    </legend>
                    
                    <div class="govuk-inset-text">
                      <p class="govuk-body">Current status: 
                        {% if submission.status === 'Submission Received' %}
                          <strong class="govuk-tag govuk-tag--purple">{{ submission.status }}</strong>
                        {% elif submission.status === 'Under Review' %}
                          <strong class="govuk-tag govuk-tag--blue">{{ submission.status }}</strong>
                        {% elif submission.status === 'Approved' %}
                          <strong class="govuk-tag govuk-tag--green">{{ submission.status }}</strong>
                        {% elif submission.status === 'Implementation Scheduled' %}
                          <strong class="govuk-tag govuk-tag--yellow">{{ submission.status }}</strong>
                        {% elif submission.status === 'In Progress' %}
                          <strong class="govuk-tag govuk-tag--light-blue">{{ submission.status }}</strong>
                        {% elif submission.status === 'Implemented' %}
                          <strong class="govuk-tag govuk-tag--pink">{{ submission.status }}</strong>
                        {% elif submission.status === 'Go Live' %}
                          <strong class="govuk-tag govuk-tag--purple">{{ submission.status }}</strong>
                        {% elif submission.status === 'Completed' %}
                          <strong class="govuk-tag govuk-tag--turquoise">{{ submission.status }}</strong>
                        {% elif submission.status === 'Rejected' %}
                          <strong class="govuk-tag govuk-tag--red">{{ submission.status }}</strong>
                        {% else %}
                          <strong class="govuk-tag govuk-tag--grey">{{ submission.status }}</strong>
                        {% endif %}
                      </p>
                      <p class="govuk-body">Current phase: <strong class="govuk-tag govuk-tag--light-blue">{{ phases | selectattr('value', 'equalto', extractedCurrentPhaseId) | map(attribute='name') | first | default('Current Phase') }}</strong></p>
                      {% if submission.notes %}
                        <p class="govuk-body">Phase completion status:</p>
                        <div class="govuk-grid-row">
                          {% for phase in phases %}
                            {% set phaseCompleted = false %}
                            {% if submission.notes %}
                              {% set notesLines = submission.notes.split('\n') %}
                              {% for line in notesLines %}
                                {% if ('Phase ' + phase.value + ' completed') in line %}
                                  {% set phaseCompleted = true %}
                                {% endif %}
                              {% endfor %}
                            {% endif %}
                            
                            {% if loop.index0 % 4 == 0 and loop.index0 != 0 %}
                            </div>
                            <div class="govuk-grid-row">
                            {% endif %}
                            
                            <div class="govuk-grid-column-one-quarter govuk-!-margin-bottom-3">
                              {% if phaseCompleted %}
                                <strong class="govuk-tag govuk-tag--green">{{ phase.value }}</strong>
                                <p class="govuk-body-s govuk-!-margin-bottom-0">{{ phase.name.split(' - ')[0] }}</p>
                                <p class="govuk-body-s govuk-!-margin-bottom-0 govuk-!-font-weight-bold">Completed</p>
                              {% elif phase.value | int === extractedCurrentPhaseId %}
                                <strong class="govuk-tag govuk-tag--light-blue">{{ phase.value }}</strong>
                                <p class="govuk-body-s govuk-!-margin-bottom-0">{{ phase.name.split(' - ')[0] }}</p>
                                <p class="govuk-body-s govuk-!-margin-bottom-0 govuk-!-font-weight-bold">Current</p>
                              {% elif phase.value | int < extractedCurrentPhaseId %}
                                <strong class="govuk-tag govuk-tag--grey">{{ phase.value }}</strong>
                                <p class="govuk-body-s govuk-!-margin-bottom-0">{{ phase.name.split(' - ')[0] }}</p>
                                <p class="govuk-body-s govuk-!-margin-bottom-0 govuk-!-font-weight-bold">Skipped</p>
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                    
                    <div class="govuk-form-group">
                      <label class="govuk-label" for="phaseId">
                        Phase
                      </label>
                      <select class="govuk-select" id="phaseId" name="phaseId">
                        <option value="">Select a phase</option>
                        {# Use the already extracted current phase ID #}
                        {% set currentPhaseId = extractedCurrentPhaseId %}
                        {% set nextPhaseId = currentPhaseId + 1 %}
                        
                        {# For simplicity, we'll just consider phases with values less than the current phase ID as completed #}
                        {% set completedPhases = [] %}
                        {% for phase in phases %}
                          {% if phase.value | int < currentPhaseId %}
                            {# This phase is completed based on the current phase ID #}
                            {% set isCompleted = true %}
                          {% else %}
                            {% set isCompleted = false %}
                          {% endif %}
                          
                          {# Store the completion status with the phase for later reference #}
                          {% if isCompleted %}
                            {# We can't modify the phase object directly, but we can track completed phase values #}
                            {% set completedPhases = completedPhases + [phase.value | int] %}
                          {% endif %}
                        {% endfor %}
                        
                        {# Show current phase and next phase only if current phase is not completed #}
                        {% set currentPhaseCompleted = false %}
                        {% for completedPhase in completedPhases %}
                          {% if completedPhase === currentPhaseId %}
                            {% set currentPhaseCompleted = true %}
                          {% endif %}
                        {% endfor %}
                        
                        {# Display all phases in the dropdown #}
                        {% for phase in phases %}
                          <option value="{{ phase.value }}" {% if phase.value | int == currentPhaseId %}selected{% endif %}>
                            Phase {{ phase.value }}: {{ phase.name }} 
                            {% if phase.value | int == currentPhaseId %}(Current){% endif %}
                            {% if phase.value | int == nextPhaseId %}(Next Phase){% endif %}
                          </option>
                        {% endfor %}
                        
                        {# Add special options #}
                        <option value="reject">Reject BCR</option>
                        <option value="complete">Mark as Complete</option>
                      </select>
                      <div class="govuk-hint">When you mark a phase as completed, the workflow will automatically advance to the next phase.</div>
                    </div>
                    
                    <!-- Status dropdown has been removed as requested -->
                    
                    <div class="govuk-form-group">
                      <label class="govuk-label" for="assignedReviewer">
                        Assigned Reviewer
                      </label>
                      <input class="govuk-input" id="assignedReviewer" name="assignedReviewer" type="text" value="{{ submission.assignedReviewer }}">
                    </div>
                    
                    <div class="govuk-form-group">
                      <label class="govuk-label" for="comment">
                        Comment <span class="govuk-required">*</span>
                      </label>
                      <div class="govuk-hint">Please provide a comment explaining this status change</div>
                      <textarea class="govuk-textarea" id="comment" name="comment" rows="3" required></textarea>
                    </div>
                    
                    <div class="govuk-form-group">
                      <label class="govuk-label" for="user">
                        Your Name <span class="govuk-required">*</span>
                      </label>
                      <input class="govuk-input" id="user" name="user" type="text" required>
                    </div>
                    
                    <div class="govuk-form-group">
                      <div class="govuk-checkboxes">
                        <div class="govuk-checkboxes__item">
                          <input class="govuk-checkboxes__input" id="phaseCompleted" name="phaseCompleted" type="checkbox" value="true">
                          <label class="govuk-label govuk-checkboxes__label" for="phaseCompleted">
                            Mark this phase as completed
                          </label>
                        </div>
                      </div>
                    </div>
                  </fieldset>
                </div>
                
                <button class="govuk-button" data-module="govuk-button">
                  Update BCR
                </button>
              </form>
              

            </div>
          </div>
        </div>
        
        <!-- Impact Areas Tab -->
        <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="impact-areas" role="tabpanel" aria-labelledby="tab_impact-areas" tabindex="0">
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
              <h2 class="govuk-heading-l">Impact Areas</h2>
              
              <!-- Current Impact Areas -->
              <div class="app-card govuk-!-margin-bottom-6">
                <h3 class="govuk-heading-m">Current Impact Areas</h3>
                <div class="govuk-grid-row">
                  <div class="govuk-grid-column-full">
                    {% if submission.impactAreas and submission.impactAreas.length > 0 %}
                      <div class="govuk-!-margin-bottom-4">
                        {% for area in submission.impactAreas %}
                          {% if area === "API" %}
                            <span class="govuk-tag govuk-tag--blue govuk-!-margin-right-2 govuk-!-margin-bottom-2">{{ area }}</span>
                          {% elif area === "CSV" %}
                            <span class="govuk-tag govuk-tag--green govuk-!-margin-right-2 govuk-!-margin-bottom-2">{{ area }}</span>
                          {% elif area === "Frontend UI" %}
                            <span class="govuk-tag govuk-tag--purple govuk-!-margin-right-2 govuk-!-margin-bottom-2">{{ area }}</span>
                          {% elif area === "Validation" %}
                            <span class="govuk-tag govuk-tag--red govuk-!-margin-right-2 govuk-!-margin-bottom-2">{{ area }}</span>
                          {% elif area === "Reference Data" %}
                            <span class="govuk-tag govuk-tag--turquoise govuk-!-margin-right-2 govuk-!-margin-bottom-2">{{ area }}</span>
                          {% elif area === "Content and Guidance" %}
                            <span class="govuk-tag govuk-tag--pink govuk-!-margin-right-2 govuk-!-margin-bottom-2">{{ area }}</span>
                          {% else %}
                            <span class="govuk-tag govuk-tag--grey govuk-!-margin-right-2 govuk-!-margin-bottom-2">{{ area }}</span>
                          {% endif %}
                        {% endfor %}
                      </div>
                    {% else %}
                      <p class="govuk-body">No impact areas have been specified for this BCR.</p>
                    {% endif %}
                  </div>
                </div>
              </div>
              
              <!-- Add Impact Areas -->
              <div class="app-card govuk-!-margin-bottom-6">
                <h3 class="govuk-heading-m">Add Impact Area</h3>
                <form action="/bcr/submissions/{{ submission.id }}/impact-areas/add" method="post" class="govuk-!-margin-bottom-0">
                  <div class="govuk-form-group">
                    <fieldset class="govuk-fieldset">
                      <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
                        <h3 class="govuk-fieldset__heading">Select which of the following your change request relates to <span class="govuk-required">*</span></h3>
                      </legend>
                      <div class="govuk-checkboxes" data-module="govuk-checkboxes">
                        <div class="govuk-checkboxes__item">
                          <input class="govuk-checkboxes__input" id="impact-api" name="impactAreas[]" type="checkbox" value="API">
                          <label class="govuk-label govuk-checkboxes__label" for="impact-api">API</label>
                        </div>
                        <div class="govuk-checkboxes__item">
                          <input class="govuk-checkboxes__input" id="impact-csv" name="impactAreas[]" type="checkbox" value="CSV">
                          <label class="govuk-label govuk-checkboxes__label" for="impact-csv">CSV</label>
                        </div>
                        <div class="govuk-checkboxes__item">
                          <input class="govuk-checkboxes__input" id="impact-frontend" name="impactAreas[]" type="checkbox" value="Frontend UI">
                          <label class="govuk-label govuk-checkboxes__label" for="impact-frontend">Frontend UI</label>
                        </div>
                        <div class="govuk-checkboxes__item">
                          <input class="govuk-checkboxes__input" id="impact-validation" name="impactAreas[]" type="checkbox" value="Validation">
                          <label class="govuk-label govuk-checkboxes__label" for="impact-validation">Validation</label>
                        </div>
                        <div class="govuk-checkboxes__item">
                          <input class="govuk-checkboxes__input" id="impact-reference-data" name="impactAreas[]" type="checkbox" value="Reference Data">
                          <label class="govuk-label govuk-checkboxes__label" for="impact-reference-data">Reference Data</label>
                        </div>
                        <div class="govuk-checkboxes__item">
                          <input class="govuk-checkboxes__input" id="impact-content" name="impactAreas[]" type="checkbox" value="Content and Guidance">
                          <label class="govuk-label govuk-checkboxes__label" for="impact-content">Content and Guidance</label>
                        </div>
                        <div class="govuk-checkboxes__item">
                          <input class="govuk-checkboxes__input" id="impact-other" name="impactAreas[]" type="checkbox" value="Other" data-aria-controls="conditional-impact-other">
                          <label class="govuk-label govuk-checkboxes__label" for="impact-other">Other</label>
                        </div>
                        <div class="govuk-checkboxes__conditional govuk-checkboxes__conditional--hidden" id="conditional-impact-other">
                          <div class="govuk-form-group">
                            <label class="govuk-label" for="impact-other-details">
                              Please specify
                            </label>
                            <input class="govuk-input" id="impact-other-details" name="otherImpactArea" type="text">
                          </div>
                        </div>
                      </div>
                    </fieldset>
                  </div>
                  
                  <div class="govuk-form-group">
                    <label class="govuk-label" for="impactDetails">
                      Impact Details
                    </label>
                    <textarea class="govuk-textarea" id="impactDetails" name="impactDetails" rows="5" aria-describedby="impactDetails-hint"></textarea>
                    <div id="impactDetails-hint" class="govuk-hint">
                      Provide details about how this area is impacted by the change request.
                    </div>
                  </div>
                  
                  <div class="govuk-form-group">
                    <fieldset class="govuk-fieldset">
                      <legend class="govuk-fieldset__legend">
                        <h3 class="govuk-fieldset__heading">Impact Severity</h3>
                      </legend>
                      <div class="govuk-radios">
                        <div class="govuk-radios__item">
                          <input class="govuk-radios__input" id="severity-high" name="severity" type="radio" value="High">
                          <label class="govuk-label govuk-radios__label" for="severity-high">
                            High
                          </label>
                        </div>
                        <div class="govuk-radios__item">
                          <input class="govuk-radios__input" id="severity-medium" name="severity" type="radio" value="Medium">
                          <label class="govuk-label govuk-radios__label" for="severity-medium">
                            Medium
                          </label>
                        </div>
                        <div class="govuk-radios__item">
                          <input class="govuk-radios__input" id="severity-low" name="severity" type="radio" value="Low">
                          <label class="govuk-label govuk-radios__label" for="severity-low">
                            Low
                          </label>
                        </div>
                      </div>
                    </fieldset>
                  </div>
                  
                  <button type="submit" class="govuk-button" data-module="govuk-button">
                    Add Impact Area
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Reset Workflow Tab -->
        <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="reset-workflow" role="tabpanel" aria-labelledby="tab_reset-workflow" tabindex="0">
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
              <h2 class="govuk-heading-l">Reset Workflow</h2>
              
              <div class="govuk-warning-text govuk-!-margin-bottom-6">
                <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                <strong class="govuk-warning-text__text">
                  <span class="govuk-visually-hidden">Warning</span>
                  Resetting the workflow will change the status to "Submission Received" and mark all subsequent phases as incomplete.
                </strong>
              </div>
              
              <div class="app-card govuk-!-margin-bottom-6">
                <h3 class="govuk-heading-m">Current Status</h3>
                <p class="govuk-body">
                  {% if submission.status === 'Submission Received' %}
                    <strong class="govuk-tag govuk-tag--purple">{{ submission.status }}</strong>
                  {% elif submission.status === 'Under Review' %}
                    <strong class="govuk-tag govuk-tag--blue">{{ submission.status }}</strong>
                  {% elif submission.status === 'Approved' %}
                    <strong class="govuk-tag govuk-tag--green">{{ submission.status }}</strong>
                  {% elif submission.status === 'Implementation Scheduled' %}
                    <strong class="govuk-tag govuk-tag--yellow">{{ submission.status }}</strong>
                  {% elif submission.status === 'In Progress' %}
                    <strong class="govuk-tag govuk-tag--light-blue">{{ submission.status }}</strong>
                  {% elif submission.status === 'Implemented' %}
                    <strong class="govuk-tag govuk-tag--pink">{{ submission.status }}</strong>
                  {% elif submission.status === 'Go Live' %}
                    <strong class="govuk-tag govuk-tag--turquoise">{{ submission.status }}</strong>
                  {% elif submission.status === 'Completed' %}
                    <strong class="govuk-tag govuk-tag--green">{{ submission.status }}</strong>
                  {% elif submission.status === 'Rejected' %}
                    <strong class="govuk-tag govuk-tag--red">{{ submission.status }}</strong>
                  {% else %}
                    <strong class="govuk-tag govuk-tag--grey">{{ submission.status }}</strong>
                  {% endif %}
                </p>
              </div>
              
              <div class="app-card govuk-!-margin-bottom-6">
                <h3 class="govuk-heading-m">Reset Workflow Form</h3>
                <form action="/bcr/submissions/{{ submission.id }}/reset-workflow" method="post" novalidate>
                  <div class="govuk-form-group">
                    <label class="govuk-label" for="comment">
                      Comment <span class="govuk-required">*</span>
                    </label>
                    <div class="govuk-hint">
                      Please provide a reason for resetting the workflow. This will be recorded in the history.
                    </div>
                    <textarea class="govuk-textarea" id="comment" name="comment" rows="5" required></textarea>
                  </div>
                  
                  <div class="govuk-form-group">
                    <label class="govuk-label" for="user">
                      Your Name <span class="govuk-required">*</span>
                    </label>
                    <input class="govuk-input" id="user" name="user" type="text" required>
                  </div>
                  
                  <button type="submit" class="govuk-button govuk-button--warning" data-module="govuk-button" style="background-color: #d4351c; color: white;">
                    Reset Workflow to Received
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Change History Tab -->
        <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="history" role="tabpanel" aria-labelledby="tab_history" tabindex="0">
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
              <h2 class="govuk-heading-l">Change History</h2>
              
              <table class="govuk-table">
                <caption class="govuk-table__caption govuk-table__caption--m">Audit log</caption>
                <thead class="govuk-table__head">
                  <tr class="govuk-table__row">
                    <th scope="col" class="govuk-table__header">Date</th>
                    <th scope="col" class="govuk-table__header">Action</th>
                    <th scope="col" class="govuk-table__header">User</th>
                    <th scope="col" class="govuk-table__header">Notes</th>
                  </tr>
                </thead>
                <tbody class="govuk-table__body">
                  {% for item in submission.history | reverse %}
                    <tr class="govuk-table__row">
                      <td class="govuk-table__cell">{{ item.date | date }}</td>
                      <td class="govuk-table__cell">{{ item.action }}</td>
                      <td class="govuk-table__cell">{{ item.user }}</td>
                      <td class="govuk-table__cell">{{ item.notes }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
