{% extends "layouts/base-with-nav.njk" %}

{% block title %}
  {{ title }} - RRDM
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h1 class="govuk-heading-xl">BCR Dashboard</h1>
    <p class="govuk-body-l">Manage and track Business Change Requests</p>
  </div>
</div>

<!-- Overview Section -->
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h2 class="govuk-heading-l govuk-!-margin-top-6 govuk-!-margin-bottom-4">Overview</h2>
  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-one-third">
    <div class="app-card app-card--blue">
      <h2 class="govuk-heading-m">{{ stats.total }}</h2>
      <p class="govuk-body">Total BCRs</p>
    </div>
  </div>
  <div class="govuk-grid-column-one-third">
    <div class="app-card app-card--light-blue">
      <h2 class="govuk-heading-m">{{ stats.pending }}</h2>
      <p class="govuk-body">Pending BCRs</p>
    </div>
  </div>
  <div class="govuk-grid-column-one-third">
    <div class="app-card app-card--green">
      <h2 class="govuk-heading-m">{{ stats.approved }}</h2>
      <p class="govuk-body">Approved BCRs</p>
    </div>
  </div>
</div>

<div class="govuk-grid-row govuk-!-margin-top-4">
  <div class="govuk-grid-column-one-third">
    <div class="app-card app-card--red">
      <h2 class="govuk-heading-m">{{ stats.rejected }}</h2>
      <p class="govuk-body">Rejected BCRs</p>
    </div>
  </div>
  <div class="govuk-grid-column-one-third">
    <div class="app-card app-card--purple">
      <h2 class="govuk-heading-m">{{ stats.implemented }}</h2>
      <p class="govuk-body">Implemented BCRs</p>
    </div>
  </div>
  <div class="govuk-grid-column-one-third">
    <div class="app-card app-card--turquoise">
      <h2 class="govuk-heading-m">{{ stats.pendingSubmissions }}</h2>
      <p class="govuk-body">Pending Submissions</p>
    </div>
  </div>
</div>

<!-- Submissions Section -->
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h2 class="govuk-heading-l govuk-!-margin-top-6 govuk-!-margin-bottom-4">Submissions Overview</h2>
  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-one-quarter">
    <div class="app-card app-card--blue">
      <h2 class="govuk-heading-m">{{ stats.totalSubmissions }}</h2>
      <p class="govuk-body">Total Submissions</p>
    </div>
  </div>
  <div class="govuk-grid-column-one-quarter">
    <div class="app-card app-card--light-blue">
      <h2 class="govuk-heading-m">{{ stats.pendingSubmissions }}</h2>
      <p class="govuk-body">Pending Review</p>
    </div>
  </div>
  <div class="govuk-grid-column-one-quarter">
    <div class="app-card app-card--green">
      <h2 class="govuk-heading-m">{{ stats.approvedSubmissions }}</h2>
      <p class="govuk-body">Approved</p>
    </div>
  </div>
  <div class="govuk-grid-column-one-quarter">
    <div class="app-card app-card--red">
      <h2 class="govuk-heading-m">{{ stats.rejectedSubmissions }}</h2>
      <p class="govuk-body">Rejected</p>
    </div>
  </div>
</div>

<!-- Quick Actions Section -->
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h2 class="govuk-heading-l govuk-!-margin-top-6 govuk-!-margin-bottom-4">Quick Actions</h2>
  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-one-third">
    <div class="app-card app-card--blue">
      <h2 class="govuk-heading-m">New BCR Submission</h2>
      <p class="govuk-body">Create a new Business Change Request for review.</p>
      <a href="/bcr-submission/new" class="govuk-button">Create BCR</a>
    </div>
  </div>
  <div class="govuk-grid-column-one-third">
    <div class="app-card app-card--turquoise">
      <h2 class="govuk-heading-m">Review Submissions</h2>
      <p class="govuk-body">Review pending BCR submissions ({{ stats.pendingSubmissions }}).</p>
      <a href="/bcr-submission" class="govuk-button">Review Submissions</a>
    </div>
  </div>
  <div class="govuk-grid-column-one-third">
    <div class="app-card app-card--purple">
      <h2 class="govuk-heading-m">Workflow Management</h2>
      <p class="govuk-body">View and manage the BCR workflow process.</p>
      <a href="/bcr/workflow" class="govuk-button">Manage Workflow</a>
    </div>
  </div>
</div>

<!-- BCR Lists Section -->
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h2 class="govuk-heading-l govuk-!-margin-top-6 govuk-!-margin-bottom-4">BCR Status</h2>
  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <div class="govuk-tabs" data-module="govuk-tabs">
      <h2 class="govuk-tabs__title">
        BCR Status
      </h2>
      <h3 class="govuk-heading-m">Total BCRs: {{ totalBcrsCount }}</h3>
      <ul class="govuk-tabs__list">
        <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
          <a class="govuk-tabs__tab" href="#active">
            Active BCRs ({{ activeBcrsCount }})
          </a>
        </li>
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#completed">
            Completed BCRs ({{ completedBcrsCount }})
          </a>
        </li>
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#rejected">
            Rejected BCRs ({{ rejectedBcrsCount }})
          </a>
        </li>
      </ul>
        
        <div class="govuk-tabs__panel" id="active">
          <h2 class="govuk-heading-l">Active BCRs</h2>
          
          <div class="govuk-form-group">
            <label class="govuk-label" for="filter-active">Filter by phase</label>
            <select class="govuk-select" id="filter-active" name="filter-active">
              <option value="all">All phases</option>
              {% for phase in workflowPhases %}
                <option value="{{ phase }}">{{ phase }}</option>
              {% endfor %}
            </select>
          </div>
          
          {% if activeBcrs.length === 0 %}
            <p class="govuk-body">There are no active BCRs.</p>
          {% else %}
            <table class="govuk-table">
              <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                  <th scope="col" class="govuk-table__header">BCR Code</th>
                  <th scope="col" class="govuk-table__header">Title</th>
                  <th scope="col" class="govuk-table__header">Current Phase</th>
                  <th scope="col" class="govuk-table__header">Status</th>
                  <th scope="col" class="govuk-table__header">Urgency</th>
                  <th scope="col" class="govuk-table__header">Submission Ref</th>
                  <th scope="col" class="govuk-table__header">Last Updated</th>
                  <th scope="col" class="govuk-table__header">Actions</th>
                </tr>
              </thead>
              <tbody class="govuk-table__body">
                {% for bcr in activeBcrs %}
                  <tr class="govuk-table__row" data-phase="{{ bcr.currentPhase }}">
                    <td class="govuk-table__cell">
                      <a href="/bcr/{{ bcr.id }}" class="govuk-link">{{ bcr.bcrCode }}</a>
                    </td>
                    <td class="govuk-table__cell">{{ bcr.title | truncate(30) }}</td>
                    <td class="govuk-table__cell">
                      <strong class="govuk-tag">{{ bcr.currentPhase }}</strong>
                    </td>
                    <td class="govuk-table__cell">
                      <strong class="{{ bcr.statusTagColor }}">{{ bcr.status | replace('_', ' ') | title }}</strong>
                    </td>
                    <td class="govuk-table__cell">{{ bcr.urgencyLevel }}</td>
                    <td class="govuk-table__cell">
                      {% if bcr.submissionCode %}
                        <strong class="govuk-tag govuk-tag--purple">{{ bcr.submissionCode }}</strong>
                      {% else %}
                        {% if bcr.submission and bcr.submission.submissionCode %}
                          <strong class="govuk-tag govuk-tag--purple">{{ bcr.submission.submissionCode }}</strong>
                        {% else %}
                          -
                        {% endif %}
                      {% endif %}
                    </td>
                    <td class="govuk-table__cell">{{ bcr.updatedAt | date }}</td>
                    <td class="govuk-table__cell">
                      <a href="/bcr/{{ bcr.id }}" class="govuk-link">View</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endif %}
        </div>
        
        <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="completed">
          <h2 class="govuk-heading-l">Completed BCRs</h2>
          
          {% if completedBcrs.length === 0 %}
            <p class="govuk-body">There are no completed BCRs.</p>
          {% else %}
            <table class="govuk-table">
              <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                  <th scope="col" class="govuk-table__header">BCR Code</th>
                  <th scope="col" class="govuk-table__header">Title</th>
                  <th scope="col" class="govuk-table__header">Completion Date</th>
                  <th scope="col" class="govuk-table__header">Actions</th>
                </tr>
              </thead>
              <tbody class="govuk-table__body">
                {% for bcr in completedBcrs %}
                  <tr class="govuk-table__row">
                    <td class="govuk-table__cell">{{ bcr.bcrCode }}</td>
                    <td class="govuk-table__cell">{{ bcr.title | truncate(50) }}</td>
                    <td class="govuk-table__cell">{{ bcr.completedAt | date }}</td>
                    <td class="govuk-table__cell">
                      <a href="/bcr/{{ bcr.id }}" class="govuk-link">View</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endif %}
        </div>
        
        <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="rejected">
          <h2 class="govuk-heading-l">Rejected BCRs</h2>
          
          {% if rejectedBcrs.length === 0 %}
            <p class="govuk-body">There are no rejected BCRs.</p>
          {% else %}
            <table class="govuk-table">
              <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                  <th scope="col" class="govuk-table__header">BCR Code</th>
                  <th scope="col" class="govuk-table__header">Title</th>
                  <th scope="col" class="govuk-table__header">Rejection Date</th>
                  <th scope="col" class="govuk-table__header">Reason</th>
                  <th scope="col" class="govuk-table__header">Actions</th>
                </tr>
              </thead>
              <tbody class="govuk-table__body">
                {% for bcr in rejectedBcrs %}
                  <tr class="govuk-table__row">
                    <td class="govuk-table__cell">{{ bcr.bcrCode }}</td>
                    <td class="govuk-table__cell">{{ bcr.title | truncate(30) }}</td>
                    <td class="govuk-table__cell">{{ bcr.rejectedAt | date }}</td>
                    <td class="govuk-table__cell">{{ bcr.rejectionReason | truncate(50) }}</td>
                    <td class="govuk-table__cell">
                      <a href="/bcr/{{ bcr.id }}" class="govuk-link">View</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block pageScripts %}
<script>
  // Filter active BCRs by phase
  document.addEventListener('DOMContentLoaded', function() {
    const filterSelect = document.getElementById('filter-active');
    if (filterSelect) {
      const bcrRows = document.querySelectorAll('#active tbody tr');
      
      filterSelect.addEventListener('change', function() {
        const selectedPhase = this.value;
        
        bcrRows.forEach(row => {
          if (selectedPhase === 'all' || row.dataset.phase === selectedPhase) {
            row.style.display = 'table-row';
          } else {
            row.style.display = 'none';
          }
        });
      });
    }

    // Initialize GOV.UK Frontend components
    if (window.GOVUKFrontend) {
      window.GOVUKFrontend.initAll();
    }
  });
</script>
{% endblock %}
